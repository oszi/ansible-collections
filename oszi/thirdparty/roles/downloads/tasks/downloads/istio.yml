---
- name: Install istioctl?
  when: downloads_istio_url is not none
  block:
    - name: Download the full istio archive
      ansible.builtin.get_url:
        url: "{{ downloads_istio_url }}"
        dest: "{{ downloads_cache_path }}/istio.tar.gz"
        checksum: "{{ downloads_istio_checksum }}"
        owner: "root"
        group: "root"
        mode: "0644"
      register: _get_url_result

    - name: Extract istioctl
      ansible.builtin.command: >-
        {{ downloads_tar_extract_binary }} -f {{ downloads_cache_path }}/istio.tar.gz
        --strip-components=2 *-*/bin/istioctl
      when: _get_url_result.changed

    - name: Extract istioctl completion
      ansible.builtin.command: >-
        {{ downloads_tar_extract }} -f {{ downloads_cache_path }}/istio.tar.gz -C /etc/bash_completion.d
        --strip-components=2 *-*/tools/istioctl.bash
      when: _get_url_result.changed

- name: Uninstall istioctl?
  ansible.builtin.file:
    path: "{{ item }}"
    state: "absent"
  when: downloads_istio_url is none
  with_items:
    - "{{ downloads_cache_path }}/istio.tar.gz"
    - "/etc/bash_completion.d/istioctl.bash"
    - "{{ downloads_bin_path }}/istioctl"
