---
- name: Install kubectx?
  when: downloads_kubectx_url is not none
  block:
    - name: Download the kubectx archive
      ansible.builtin.get_url:
        url: "{{ downloads_kubectx_url }}"
        dest: "{{ downloads_cache_path }}/kubectx.tar.gz"
        checksum: "{{ downloads_kubectx_checksum }}"
        owner: "root"
        group: "root"
        mode: "0644"
      register: _get_url_result

    - name: Extract kubectx scripts
      ansible.builtin.command: >-
        {{ downloads_tar_extract_binary }} -f {{ downloads_cache_path }}/kubectx.tar.gz
        --strip-components=1 *-*/kubectx *-*/kubens
      when: _get_url_result.changed

    - name: Extract kubectx completions
      ansible.builtin.command: >-
        {{ downloads_tar_extract }} -C /etc/bash_completion.d -f {{ downloads_cache_path }}/kubectx.tar.gz
        --strip-components=2 *-*/completion/*.bash
      when: _get_url_result.changed

- name: Uninstall kubectx?
  ansible.builtin.file:
    path: "{{ item }}"
    state: "absent"
  when: downloads_kubectx_url is none
  with_items:
    - "{{ downloads_cache_path }}/kubectx.tar.gz"
    - "{{ downloads_bin_path }}/kubectx"
    - "{{ downloads_bin_path }}/kubens"
    - "/etc/bash_completion.d/kubectx.bash"
    - "/etc/bash_completion.d/kubens.bash"
