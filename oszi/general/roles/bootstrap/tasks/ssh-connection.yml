---
# Automatic fact gathering must be disabled when running these tasks because it will fail
# if a custom SSH port is not yet configured. Run "setup" after the connection is established.

- name: Set bootstrap_ssh_host/port facts
  ansible.builtin.set_fact:
    bootstrap_ssh_host: "{{ ansible_host | default(inventory_hostname) }}"
    bootstrap_ssh_port: "{{ ansible_port | default(bootstrap_ssh_port_default) | string }}"
    bootstrap_ssh_port_default: "{{ bootstrap_ssh_port_default | string }}"

# It would be better to use the SSH agent but this is more portable...
- name: Use an ansible-vault encrypted SSH private key?
  when: "bootstrap_ssh_private_key is not none"
  block:
    - name: Override ansible_ssh_private_key_file
      ansible.builtin.set_fact:
        ansible_ssh_private_key_file: "/tmp/ansible_ssh_private_key_{{ bootstrap_ssh_private_key | hash('sha1') }}"

    - name: Copy SSH private key to ansible_ssh_private_key_file
      ansible.builtin.copy:
        content: "{{ bootstrap_ssh_private_key }}"
        dest: "{{ ansible_ssh_private_key_file }}"
        mode: "0600"
      changed_when: false

- name: Dynamic SSH port fallback for first-time setup
  when: "bootstrap_ssh_port != bootstrap_ssh_port_default"
  block:
    - name: Check the configured SSH port
      ansible.builtin.wait_for:
        host: "{{ bootstrap_ssh_host }}"
        port: "{{ bootstrap_ssh_port }}"
        connect_timeout: 5
        timeout: 10
        state: "started"
      check_mode: false
      ignore_errors: true
      register: _wait_for_ssh

    - name: Fallback to the default port otherwise
      ansible.builtin.set_fact:
        ansible_port: "{{ bootstrap_ssh_port_default }}"
      when: _wait_for_ssh is undefined or _wait_for_ssh.state is undefined
