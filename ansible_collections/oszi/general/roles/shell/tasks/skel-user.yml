---
- name: "Get info about user:{{ shell_user_item }}"
  ansible.builtin.user:
    name: "{{ shell_user_item }}"
    state: "present"
  # The user does not exist yet if changed!
  register: shell_user_info
  check_mode: true

- name: "Enforce /etc/skel for user:{{ shell_user_item }}"
  when: >-
    not shell_user_info.changed
    and not shell_user_info.shell.endswith('/nologin')
    and shell_user_info.home != '/'
  block:
    - name: "Enforce /etc/skel for user:{{ shell_user_item }}"
      ansible.builtin.copy:
        src: "etc/skel/"
        dest: "{{ shell_user_info.home }}/"
        owner: "{{ shell_user_item }}"
        group: "{{ shell_user_info.group }}"
        mode: "0640"

    - name: "Enforce .profile template for user:{{ shell_user_item }}"
      ansible.builtin.template:
        src: "etc/skel/.profile.j2"
        dest: "{{ shell_user_info.home }}/.profile"
        owner: "{{ shell_user_item }}"
        group: "{{ shell_user_info.group }}"
        mode: "0640"
