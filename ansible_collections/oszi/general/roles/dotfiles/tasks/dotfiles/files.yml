---
- name: "Check directories for user:{{ dotfiles_user_item }}"
  ansible.builtin.stat:
    path: "{{ dotfiles_user_info.home }}/{{ item }}"
  with_items: "{{ dotfiles_files | map('dirname') | reject('equalto', '') | unique }}"
  register: _dotfiles_directories

# Keep owners and modes of existing directories!
- name: "Create missing directories for user:{{ dotfiles_user_item }}"
  ansible.builtin.file:
    path: "{{ item.invocation.module_args.path }}"
    owner: "{{ dotfiles_user_info.uid }}"
    group: "{{ dotfiles_user_info.group }}"
    mode: "0700"
    state: "directory"
  with_items: "{{ _dotfiles_directories.results | selectattr('stat.exists', 'equalto', false) }}"

- name: "Install extra dotfiles for user:{{ dotfiles_user_item }}"
  ansible.builtin.copy:
    content: "{{ item.value }}"
    dest: "{{ dotfiles_user_info.home }}/{{ item.key }}"
    owner: "{{ dotfiles_user_info.uid }}"
    group: "{{ dotfiles_user_info.group }}"
    mode: "0600"
  with_dict: "{{ dotfiles_files }}"
