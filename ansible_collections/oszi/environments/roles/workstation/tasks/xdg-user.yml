---
- name: "Get info about user:{{ workstation_xdg_user }}"
  ansible.builtin.user:
    name: "{{ workstation_xdg_user }}"
    state: "present"
  # The user does not exist yet if changed!
  register: user_info
  check_mode: true

- name: "Fail if the workstation user does not exist"
  when: user_info.changed
  ansible.builtin.fail:
    msg: "{{ workstation_xdg_user }} user does not exist"

- name: "Ensure XDG_CONFIG_HOME exists for user:{{ workstation_xdg_user }}"
  ansible.builtin.file:
    path: "{{ user_info.home }}/{{ workstation_xdg_config_directory }}"
    owner: "{{ user_info.uid }}"
    group: "{{ user_info.group }}"
    mode: "0750"
    state: "directory"
  register: _xdg_config_directory

- name: "Install XDG user-dirs for user:{{ workstation_xdg_user }}"
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ _xdg_config_directory.path }}/{{ item | basename | regex_replace('\\.j2$', '') }}"
    owner: "{{ user_info.uid }}"
    group: "{{ user_info.group }}"
    mode: "0640"
  with_fileglob:
    - "templates/home/.config/user-dirs.*.j2"
