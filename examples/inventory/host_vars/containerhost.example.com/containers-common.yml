---
podman_graphroot: "/opt/containers/graphroot"

podman_networks:
  vmbridge-containers:
    driver: "macvlan"
    gateway: "{{ _containers_subnet | ipaddr('1') }}"
    subnet: "{{ _containers_subnet }}"
    ip_range: "{{ _containers_ip_range }}"
    ipv6: false
    opt:
      parent: "enp1s0"
      mode: "bridge"

_containers_subnet: "172.17.0.0/24"
_containers_ip_range: "172.17.0.240/28"

_quadlet_container_common: |
    ContainerName=%N
    DNS={{ _containers_subnet | ipaddr('1') }}
    DNSSearch=.
    Sysctl=net.ipv6.conf.all.disable_ipv6=1
    Sysctl=net.ipv6.conf.default.disable_ipv6=1
    DropCapability=ALL
    AddCapability=CHOWN KILL NET_BIND_SERVICE
    NoNewPrivileges=true
    ReadOnly=true
    ReadOnlyTmpfs=true
    Tmpfs=/run:exec
    AutoUpdate=local

_container_runtime_options_common:  # XXX
  - "--uidmap=${HOST_UIDMAP}"
  - "--gidmap=${HOST_UIDMAP}"
  - "--dns={{ _containers_subnet | ipaddr('1') }}"
  - "--dns-search=."
  - "--security-opt=no-new-privileges"
  - "--cap-drop=ALL"
  - "--cap-add=CHOWN"
  - "--cap-add=KILL"
  - "--cap-add=NET_BIND_SERVICE"
  - "--tmpfs=/run:exec"
  - "--tmpfs=/tmp"
  - "--read-only"

_certbot_uid0: 130000

_container_certbot_exec_command: |-
  {{ containerhost_runtime }} run \
      --name=%N-certbot \
      --sdnotify=ignore \
      --replace \
      --rm \
      --uidmap=0:{{ _certbot_uid0 }}:65536 \
      --gidmap=0:{{ _certbot_uid0 }}:65536 \
      --cap-drop=ALL \
      --volume={{ containerhost_etc_path }}/%N/letsencrypt:/etc/letsencrypt:rw,U,Z \
      docker.io/certbot/dns-cloudflare \
      certonly --config /etc/letsencrypt/cli.ini

_container_certbot_cli_ini: |
  agree-tos
  non-interactive
  email admin@example.com
  dns-cloudflare
  dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini

_container_certbot_cloudflare_ini: |
  dns_cloudflare_api_token = "{{ cloudflare_api_token }}"
